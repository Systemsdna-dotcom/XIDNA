
@model XICore.XIIComponent
@using XISystem
@using XICore
@using System.Globalization;
@{
    XIGraphData oXIGraph = new XIGraphData();
    List<XIIBO> values = new List<XIIBO>();
    List<string> Keys = new List<string>();
    List<XIVisualisationNV> oXIVisualisations = new List<XIVisualisationNV>();
    var sColour = new List<string>();
    oXIGraph = (XIGraphData)Model.oContent[XIConstant.AM4ColumnLineChartComponent];
    // int n = 0;
    int forseries = 0;
    if (Model.oContent.ContainsKey(XIConstant.AM4ColumnLineChartComponent))
    {
        Dictionary<List<string>, List<XIIBO>> OneClickRes = new Dictionary<List<string>, List<XIIBO>>();
        if (Model.oContent.Count() != 0)
        {
            OneClickRes = oXIGraph.ComOneClick;
            if (OneClickRes != null)
            {
                values = OneClickRes.Select(s => s.Value).FirstOrDefault();
                Keys = OneClickRes.Select(s => s.Key).FirstOrDefault();
                oXIVisualisations = oXIGraph.oXIVisualisations;
            }
            if (oXIGraph.sColours == null)
            {
                sColour = "#00ff00,#ffff00,#800000,#800080,#0000ff,#ffa500".Split(',').ToList();
            }
            else
            {
                sColour = oXIGraph.sColours;
            }
        }
    }
}

<div style="text-align: right"><label>Last Updated:-<strong>@oXIGraph.sLastUpdated</strong></label></div>
<p class="chart-title">@oXIGraph.QueryName</p>

<div class="main-wrapper side-menu">
    <div class="page-content">
        <div class="row">
            <div class="col-sm-6 col-md-10 col-lg-10">
                <div id="am4ColumnLineChart-@oXIGraph.iOneClickID" class="section">
                </div>
            </div>
        </div><!-- /.page-content -->
    </div>
</div><!-- /.main-wrapper -->

<script>
    $(document).ready(function () {
        debugger;
        var JsonData=@Html.Raw(Json.Encode(values));
        JsonData.OneClick='@oXIGraph.iOneClickID';
        JsonData.RowXilinkID='@oXIGraph.RowXilinkID';
        var Keys=@Html.Raw(Json.Encode(Keys));
        var Colour=@Html.Raw(Json.Encode(sColour));
        var oParams = [];
        $.each(JsonData, function (i, item) {
            var LeadCount = [];
            if (item.Attributes != null) {
                $.each(Keys,function(m,BarKeys){
                    LeadCount.push((item.Attributes[BarKeys].sValue));
                });
                var Param = {};
                $.each(LeadCount,function(p,BarKeys){
                    if(p==0)
                        Param["value"+p] = BarKeys;
                    else
                        Param["value"+p]=parseInt(BarKeys);
                });
                oParams.push(Param);
            }
        });
        // Apply chart themes
        am4core.useTheme(am4themes_animated);
        //am4core.useTheme(am4themes_kelly);

        var BarID = "am4ColumnLineChart-" + parseInt(JsonData.OneClick);
        // Create chart instance
        var chart = am4core.create(BarID, am4charts.XYChart);

        // Add data
        chart.data =oParams;//dataProvider;

        // Create axes
        var categoryAxis = chart.xAxes.push(new am4charts.CategoryAxis());
        categoryAxis.dataFields.category = "value0";
        categoryAxis.renderer.grid.template.location = 0;
        categoryAxis.renderer.line.strokeOpacity = 0;
        categoryAxis.renderer.minGridDistance = 0;

        categoryAxis.renderer.cellStartLocation = 0.1;
        categoryAxis.renderer.cellEndLocation = 0.8;

        var  valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
        //valueAxis.title.text = "Count";

        forseries=1;
        var KeysLength=Keys.length;
        // Create series
        var ResultData=oParams[0];
        for (var key in ResultData) {
            if (ResultData.hasOwnProperty(key)) {
                debugger;
                if(key!="value0"){
                var series="series"+forseries;
                    if(KeysLength-1 != forseries){
                        // Create series
                        var name=Keys[forseries];
                        createSeries(key, name);
                    //series = chart.series.push(new am4charts.ColumnSeries());
                    //series.dataFields.valueY = key;
                    //series.dataFields.categoryX ="value0";
                    //series.name = Keys[forseries]; //"Sales";
                    //series.tooltipText = "{name}: [bold]{valueY}[/]";
                    //if(Colour.length>0){
                    //    var columnTemplate ="columnTemplate"+forseries;
                    //    columnTemplate= series.columns.template;
                    //    columnTemplate.tooltipText = "{categoryY}: [bold]{valueX}[/]";
                    //    columnTemplate.fillOpacity = .8;
                    //    columnTemplate.strokeOpacity = 0;
                    //    columnTemplate.fill = am4core.color(Colour[forseries-1]);
                    //}
                    }
                    else{



                    series = chart.series.push(new am4charts.LineSeries());
                        //series.name = "Units";
                    series.name = Keys[forseries];
                    series.stroke = am4core.color("#CDA2AB");
                    series.strokeWidth = 3;
                    series.dataFields.valueY = key;
                    series.dataFields.categoryX = "value0";
                    series.tooltipText = "{name}: [bold]{valueY}[/]";
                    }



                    forseries++;
                }
            }
        }

        function createSeries(key, name) {

            // Set up series
            series = chart.series.push(new am4charts.ColumnSeries());
            series.name = name;
            series.dataFields.valueY = key;
            series.dataFields.categoryX ="value0";
            series.sequencedInterpolation = true;

            // Make it stacked
            series.stacked = true;

            // Configure columns
            series.columns.template.width = am4core.percent(60);
            series.columns.template.tooltipText = "[bold]{name}[/]\n[font-size:14px]{valueY}";

            // Add label
            var labelBullet = series.bullets.push(new am4charts.LabelBullet());
            labelBullet.label.text = "{valueY}";
            labelBullet.locationY = 0.5;
            labelBullet.label.hideOversized = true;

            return series;
        }



        // Add cursor
        chart.cursor = new am4charts.XYCursor();
        chart.legend = new am4charts.Legend();
        chart.legend.position = "bottom";
        var cellSize = 50;
        chart.events.on("datavalidated", function (ev) {
            // Get objects of interest
            var chart = ev.target;
            //var categoryAxis = 1000;

            // Calculate how we need to adjust chart height
            var adjustHeight = chart.data.length * cellSize - 10;

            // get current chart height
            var targetHeight = chart.pixelHeight + adjustHeight;

            // Set it on chart's container
            chart.svgContainer.htmlElement.style.height = targetHeight + "px";
        });
    });
</script>
